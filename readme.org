#+TITLE: Налаштування та робота з проєктом snd_analizer для Raspberry Pi Pico
#+AUTHOR: Михайло Казарян
#+DATE: 2025-02-26
#+STARTUP: overview

* SReader: Аналізатор звуку на базі Raspberry Pi Pico
SReader - це пристрій для аналізу звукових сигналів, що надходять з мікрофона, на базі Raspberry Pi Pico. Програма зчитує аналоговий вхід, обробляє дані та виводить графік на 16x2 I2C LCD-дисплей, використовуючи кастомні символи. Пристрій має енкодер для навігації по значеннях. Цей документ описує, функціональність, процес
первинного запуску, компіляції та вивантаження проєкту на Pico.

** Використання пристрою
1. Натисніть кнопку для запуску збору даних.
2. Дочекайтеся завершення запису (параметр `data_collection_complete` стане істинним).
3. Обертайте енкодер для перегляду графіка та додаткової інформації про кожен слайс.
4. Спостерігайте за анімацією активного слайсу на дисплеї.

** Функціональність
*** Зчитування звукового сигналу:
Натискання кнопки запускає таймер, який записує дані з АЦП у масив.
*** Формування графіка:
  - Розбиття даних на слайси.
  - Обчислення середнього та максимального значень для кожного слайсу.
  - Побудова вертикальних стовпчиків на дисплеї на основі обчислених значень.
*** Навігація за допомогою енкодера:
  - Після завершення збору даних (`data_collection_complete = true`) енкодер дозволяє переглядати слайси.
  - Обертання вправо відображає значення `slices_averages` та `slices_maximum` зліва направо.
  - Обертання вліво - справа наліво.
  - Поточна позиція енкодера (`encoder_slice_index`) показує номер слайсу.
*** DONE Позначення вибраного слайсу:
При прокручуванні енкодера в SReader користувач може інтерактивно переглядати слайси графіка звукових даних із чітким візуальним позначенням активного слайсу. При зміні активного слайсу оновлюється лише відповідний символ графіка, що забезпечує швидкий відгук без перемальовування всього дисплея. Другий рядок із параметрами слайсу (номер, середнє значення, максимум, наприклад, "01/1.234/2.345") залишається видимим під час прокручування, що дозволяє одночасно аналізувати дані та переглядати графік.
Залежно від налаштування #define POINTER_POSITION користувач може обрати бажаний режим позначення, змінивши одну константу в коді.
 - Якщо POINTER_POSITION == 7: нижній піксель стовпчика (рядок 7) вимикається, створюючи ефект "скорочення" знизу (наприклад, висота 4 стає рядками 6–4).
 - Якщо POINTER_POSITION == 0: верхній піксель символу (рядок 0) завжди вмикається, "подовжуючи" стовпчик до верху (наприклад, висота 4 стає рядками 7–4 + 0, висота 0 — рядок 0).

** Первинний запуск
Перед початком роботи переконайтеся, що у вас встановлені необхідні інструменти:
- Raspberry Pi Pico SDK (розташований за шляхом `../../../pico/pico-sdk/`).
- `cmake`, `make`, `picotool` та `minicom` (встановлені в системі).
- Проєктний файл `snd_analizer.c` та `Makefile` у поточному каталозі.

*** Кроки для первинного запуску:**
1. Відкрийте термінал у каталозі з `snd_analizer.c` та `Makefile`.
2. Ініціалізуйте проєкт (створення директорії `build` та генерація файлів CMake):
   #+BEGIN_SRC sh :results output
   make init
   #+END_SRC
   Очікуваний вивід:
   #+BEGIN_EXAMPLE
   Project initialized. Read 'Getting Started with Pico' at /home/pi/Bookshelf/getting-started-with-pico.pdf
   #+END_EXAMPLE
   Ця команда налаштовує `PICO_SDK_PATH` і готує проєкт до компіляції.

** Компіляція проєкту
Після ініціалізації можна скомпілювати проєкт.

**Кроки для компіляції:**
1. Виконайте команду компіляції:
   #+BEGIN_SRC sh :results output
   make compile
   #+END_SRC
   - Створюється директорія `build` (якщо її ще немає).
   - Виконується `cmake ..` та `make -j4` для паралельної компіляції.
2. Перевірте, чи з’явився файл `snd_analizer.uf2` у директорії `build`.

** Вивантаження проєкту на Pico
Після компіляції проєкт готовий до завантаження на Raspberry Pi Pico.

**Кроки для вивантаження:**
1. Підключіть Pico до комп’ютера, утримуючи кнопку BOOTSEL, щоб увійти в режим завантаження.
   - Pico з’явиться як USB-накопичувач (`/media/your_user/RPI-RP2/`).
2. Завантажте проєкт на Pico:
   #+BEGIN_SRC sh :results output
   make upload
   #+END_SRC
   - Команда компілює проєкт (якщо потрібно) і завантажує `snd_analizer.uf2` на Pico через `picotool`.
   - Після завантаження Pico автоматично перезавантажується.
3. Pico почне виконувати проєкт.

** Перевірка роботи
1. Після завантаження підключіться до Pico через термінал для моніторингу виводу:
   #+BEGIN_SRC sh :results output
   make monitor
   #+END_SRC
   - Відкриється `minicom` із параметрами `/dev/ttyACM0` та baud rate 115200.
   - Ви побачите дебаг-повідомлення, наприклад, "Encoder slice 0" або "Calling measure_pin_pressed()".
2. Натисніть на пін `MEASURE_PIN` (GPIO 3) для запуску вимірювання.
3. Поверніть енкодер для навігації по значеннях на LCD.

** Makefile
Робота з проектом відбувається через `Makefile`, який використовується в проєкті:
**Makefile**
- Файл для автоматизації компіляції, завантаження та моніторингу.
- Містить цілі:
  - `init` — налаштування проєкту з `PICO_SDK_PATH`.
  - `compile` — компіляція `snd_analizer.c` у `snd_analizer.uf2`.
  - `upload` — завантаження `.uf2` на Pico.
  - `monitor` — підключення до Pico через `minicom`.
  - `clean` та `clean-all` — очищення збірки.
** Структура файлів
Нижче описано, за що відповідають основні файли проєкту:

**snd_analizer.c**
- Основний файл із реалізацією логіки проєкту.
- Містить функції для:
  - Зчитування звукового сигналу з мікрофона через АЦП.
  - Обробки переривань від кнопки (`MEASURE_PIN`) та енкодера.
  - Побудови графіку на LCD та виведення значень у вольтах.
  - Ініціалізації апаратних компонентів (АЦП, GPIO, таймер, LCD).

**snd_analizer.h**
- Заголовковий файл із оголошеннями для `snd_analizer.c`.
- Включає:
  - Заголовки бібліотек (`stdio.h`, `pico/stdlib.h`, `hardware/adc.h` тощо).
  - Константи (`ADC_PIN`, `MEASURE_PIN`, `TOTAL_SLICES` тощо).
  - Глобальні змінні (`adc_values`, `saved_slices_averages` тощо).
  - Прототипи всіх функцій із `snd_analizer.c`.
** Нотатки
- Якщо Pico SDK розташований в іншому місці, відредагуйте `PICO_SDK_PATH` у `Makefile`:
  #+BEGIN_SRC makefile
  PICO_SDK_PATH = /path/to/pico-sdk
  #+END_SRC
- Для дебагу зніміть `@` перед командами в `Makefile`, щоб бачити повний вивід.

** Джерела
- Документація: `/home/pi/Bookshelf/getting-started-with-pico.pdf`.
